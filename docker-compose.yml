services:
  valhalla:
    image: ghcr.io/valhalla/valhalla:latest
    container_name: localrainbow-valhalla
    restart: unless-stopped
    ports:
      - "127.0.0.1:8002:8002"
    volumes:
      - valhalla_tiles:/data
    ulimits:
      nofile:
        soft: 1048576
        hard: 1048576
    # Serve Valhalla API using the config/tiles stored in the volume.
    command: ["bash", "-lc", "test -f /data/valhalla.json || (echo 'valhalla.json missing' && sleep 3600); valhalla_service /data/valhalla.json 8002"]

  adapter:
    build: ./backend
    container_name: localrainbow-adapter
    restart: unless-stopped
    environment:
      - VALHALLA_URL=http://valhalla:8002
    depends_on:
      - valhalla
    ports:
      - "127.0.0.1:8001:8000"

volumes:
  valhalla_tiles:
